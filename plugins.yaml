# Plugin Configuration for Persona Discord Bot
# Version: 3.1.0
#
# Plugins are config-driven CLI command integrations that allow the bot
# to execute approved external tools via Discord slash commands.
# Now supports chunked streaming transcription for long videos.

plugins:
  - name: transcribe
    description: "Transcribe YouTube videos or playlists to text using Whisper"
    enabled: true
    version: "3.1.0"

    command:
      name: transcribe
      description: "Transcribe a YouTube video or playlist and post the transcript(s) in a thread"
      options:
        - name: url
          description: "YouTube video or playlist URL to transcribe"
          type: string
          required: true
          validation:
            # Supports: youtube.com/watch?v=ID, youtube.com/shorts/ID, youtu.be/ID
            # Also allows query params like &t=123, &list=..., etc.
            # Now also supports: youtube.com/playlist?list=ID
            pattern: "^https?://(www\\.)?(youtube\\.com/(watch\\?v=|shorts/|playlist\\?list=)|youtu\\.be/)[a-zA-Z0-9_-]+([?&][a-zA-Z0-9_=-]*)?"
            max_length: 300
        - name: max_videos
          description: "Maximum videos to transcribe from playlist (default: 25, max: 50)"
          type: integer
          required: false
        - name: language
          description: "Language for transcription (auto-detects if not specified)"
          type: string
          required: false
          default: ""
          choices:
            - name: "Auto-detect"
              value: ""
            - name: "English"
              value: "en"
            - name: "Spanish"
              value: "es"
            - name: "French"
              value: "fr"
            - name: "German"
              value: "de"
            - name: "Portuguese"
              value: "pt"
            - name: "Japanese"
              value: "ja"
            - name: "Chinese"
              value: "zh"

    execution:
      # Use shell to chain commands: create temp dir, run transcription, output result
      # Progress logs go to /dev/null, errors are captured, transcript is output
      command: sh
      args:
        - "-c"
        - |
          TMPDIR=$(mktemp -d)
          ERRFILE=$(mktemp)
          LANG_FLAG=""
          if [ -n "${language}" ]; then
            LANG_FLAG="--language ${language}"
          fi
          if docker run --rm -v "$TMPDIR:/data/output" whisper-transcribe:latest "${url}" -m base -f txt -o /data/output $LANG_FLAG >/dev/null 2>"$ERRFILE"; then
            cat "$TMPDIR"/*.txt 2>/dev/null || echo "No transcript generated"
          else
            echo "Transcription failed:"
            cat "$ERRFILE"
          fi
          rm -rf "$TMPDIR" "$ERRFILE"
      timeout_seconds: 600      # 10 minutes max (for non-chunked short videos)
      max_output_bytes: 10485760  # 10MB

      # Chunking configuration for long videos
      # When enabled, long videos are downloaded, split into chunks, and transcribed progressively
      chunking:
        enabled: true
        chunk_duration_secs: 600      # 10-minute chunks
        chunk_timeout_secs: 300       # 5 minutes per chunk transcription
        download_timeout_secs: 300    # 5 minutes for audio download
        min_duration_for_chunking_secs: 600  # Videos longer than 10 min use chunking

        # Command for transcribing local audio files (chunks)
        # ${file} is replaced with the input file path
        file_command: sh
        file_args:
          - "-c"
          - |
            TMPDIR=$(mktemp -d)
            ERRFILE=$(mktemp)
            LANG_FLAG=""
            if [ -n "${language}" ]; then
              LANG_FLAG="--language ${language}"
            fi
            if docker run --rm -v "${file}:/data/input.mp3" -v "$TMPDIR:/data/output" whisper-transcribe:latest /data/input.mp3 -m base -f txt -o /data/output $LANG_FLAG >/dev/null 2>"$ERRFILE"; then
              cat "$TMPDIR"/*.txt 2>/dev/null || echo "No transcript generated"
            else
              echo "Transcription failed:"
              cat "$ERRFILE"
            fi
            rm -rf "$TMPDIR" "$ERRFILE"

    security:
      cooldown_seconds: 60      # 1 minute between requests per user
      guild_only: false         # Allow in DMs too

    # Playlist-specific configuration
    playlist:
      enabled: true
      max_videos_per_request: 50    # Hard limit on videos per playlist
      default_max_videos: 25        # Default if not specified by user
      concurrent_playlists_per_user: 1  # Only one active playlist per user
      cooldown_between_playlists: 300   # 5 minutes between playlist starts
      min_video_interval_seconds: 5     # Delay between videos to avoid rate limits

    output:
      create_thread: true
      thread_name_template: "Transcript: ${url}"
      auto_archive_minutes: 1440  # 24 hours
      post_as_file: true
      file_name_template: "transcript-${timestamp}.txt"
      max_inline_length: 1500
      # Use structured output: thread starter is URL, then summary, then file
      source_param: url
      summary_prompt: |
        Provide a detailed summary of this video transcript:

        1. **Overview**: A 2-3 sentence description of what the video is about
        2. **Key Points**: List the main topics and important points discussed (5-8 bullet points)
        3. **Notable Quotes/Moments**: Any significant statements or memorable moments
        4. **Conclusion**: What was the main takeaway or call to action

        Be thorough but concise. Use markdown formatting.

        Transcript:
        ${output}
      error_template: |
        **Transcription failed**

        ${error}

        Please check that:
        - The URL is a valid YouTube video
        - The video is not private or age-restricted
        - The video has audio/speech content

  # Cancel an in-progress playlist transcription
  - name: transcribe_cancel
    description: "Cancel an in-progress playlist transcription"
    enabled: true
    version: "1.0.0"

    command:
      name: transcribe_cancel
      description: "Cancel your active playlist transcription"
      options:
        - name: job_id
          description: "Playlist job ID (optional - cancels most recent if not specified)"
          type: string
          required: false

    # This is a virtual plugin - handled directly by the bot, not via CLI execution
    execution:
      command: ""  # Empty - handled internally
      args: []
      timeout_seconds: 5

    security:
      cooldown_seconds: 5
      guild_only: false

    output:
      create_thread: false
